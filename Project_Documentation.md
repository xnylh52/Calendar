# 日历应用项目文档

## ① 产品功能介绍

本项目是一个功能完善的 Android 日历应用，旨在帮助用户高效管理个人日程。主要功能包括：

1.  **多视图日历查看**：
    *   **月视图**：提供传统的月历概览，直观显示当月的日期和农历信息。
    *   **周视图**：支持按周查看，方便用户聚焦近期的日程安排。
    *   **农历显示**：贴合中国用户习惯，每个日期下直接显示对应的农历日期或节气。

2.  **日程管理**：
    *   **添加日程**：用户可以创建新的日程，设置标题、地点、描述。
    *   **时间设置**：支持设置开始和结束日期/时间，或标记为“全天”事件。
    *   **提醒功能**：提供多种提醒选项（如提前10分钟、30分钟、1小时、1天），确保用户不错过重要事项。
    *   **编辑与删除**：用户可以随时修改或删除已存在的日程。

3.  **数据导入与导出**：
    *   **ICS 导入**：支持从标准的 `.ics` 日历文件导入日程数据。
    *   **ICS 导出**：支持将本地日程导出为 `.ics` 文件，方便迁移或备份。
    *   **URL 订阅**：支持通过 URL 订阅网络日历（如公共假期日历），自动解析并添加到本地。

4.  **直观的交互体验**：
    *   **选中日期高亮**：点击日期即可查看当天的详细日程列表。
    *   **日程标记**：有日程的日期会在日历上显示小圆点标记，一目了然。

## ② 程序概要设计

本应用采用现代 Android 开发架构，确保代码的可维护性、扩展性和稳定性。

### 1. 架构模式：MVVM (Model-View-ViewModel)
*   **Model (数据层)**：负责数据的存储和处理。
    *   使用 **Room Database** 作为本地 SQLite 数据库的抽象层，提供类型安全的数据库访问。
    *   定义 `Event` 实体类映射数据库表结构。
    *   `EventDao` 提供增删改查（CRUD）操作接口。
*   **View (视图层)**：负责 UI 展示和用户交互。
    *   `MainActivity`：主界面，承载日历视图和日程列表。
    *   `AddEventActivity`：添加/编辑日程的详情页面。
    *   `EventsAdapter`：负责 RecyclerView 的列表项渲染。
*   **ViewModel (业务逻辑层)**：连接 View 和 Model，管理 UI 相关的数据。
    *   `EventViewModel`：封装了对日程数据的操作，通过 `LiveData` 或 `Flow` 向 View 暴露数据，确保配置变更（如屏幕旋转）时数据不丢失。

### 2. 核心组件与库
*   **Kotlin Coroutines (协程)**：用于处理数据库读写、网络请求等耗时操作，避免阻塞主线程，保证界面流畅。
*   **Jetpack Components**：
    *   `Lifecycle` & `ViewModel`：管理生命周期和 UI 数据。
    *   `Room`：本地数据库持久化。
    *   `ViewBinding`：替代 `findViewById`，提供空安全的视图引用。
*   **第三方库**：
    *   `kizitonwose/CalendarView`：高性能的自定义日历控件，支持高度定制化的月视图和周视图。
    *   `Material Design Components`：使用 Material Button, TextInputEditText 等组件构建现代化的 UI。

## ④ 技术亮点及其实现原理

### 1. 农历算法实现
*   **亮点**：在标准公历下方准确显示中国农历，无需联网即可计算。
*   **原理**：虽然 Android 系统 API 主要支持公历，但应用内部集成了一套农历转换算法（`LunarUtils`）。该工具类基于天文算法或查表法，将公历日期（`LocalDate`）转换为对应的农历月、日及节气信息，并在 `CalendarView` 的 `DayBinder` 中动态绑定到每个日期的视图上。

### 2. ICS 文件解析与生成
*   **亮点**：实现了标准 iCalendar (`.ics`) 格式的完整支持，实现了跨平台日历数据的互通。
*   **原理**：
    *   **解析 (Import)**：读取输入流中的文本行，利用正则或字符串匹配识别 `BEGIN:VEVENT` 到 `END:VEVENT` 的块，提取 `SUMMARY`, `DTSTART`, `DTEND`, `DESCRIPTION` 等字段，并处理时间戳格式（如 `yyyyMMddTHHmmssZ`）转换为本地时间戳。
    *   **生成 (Export)**：遍历数据库中的 `Event` 对象，按照 RFC 5545 标准拼接字符串，构建包含 `PRODID`, `VERSION`, `CALSCALE` 等头部的标准 ICS 文本格式。

### 3. 高性能日历渲染
*   **亮点**：即使在滑动浏览大量月份时，日历界面依然保持极高的流畅度（60fps）。
*   **原理**：
    *   采用了 `RecyclerView` 的复用机制（通过 `kizitonwose.CalendarView` 库实现）。日历中的每一天本质上都是一个 `ViewHolder`。
    *   **视图绑定 (View Binding)**：仅在需要时更新视图内容。例如，当用户切换月份时，只重新绑定可见区域日期的文本和标记，而非重绘整个控件。
    *   **异步数据加载**：日程标记（小圆点）的数据通过 `Flow` 异步观察，数据库查询在后台线程完成，数据准备好后才通知 UI 刷新，避免了主线程卡顿。
